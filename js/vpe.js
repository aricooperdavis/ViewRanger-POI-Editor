var loadBtn=document.getElementById("loadBtn"),exportBtn=document.getElementById("exportBtn");function error(e){console.log(e)}function loadDb(e){var o=loadBtn.files[0],t=new FileReader;t.onload=function(){worker.postMessage({action:"open",id:"open",buffer:t.result})},t.readAsArrayBuffer(o)}function exportDb(){var e=[];for(var o in poiDict)poiDict[o]||(worker.postMessage({action:"exec",id:"exec",sql:"DELETE FROM pois WHERE POI_ID="+o}),e.push(o));worker.postMessage({action:"export",id:"export"}),unplotPOIs(e)}function workerMessage(e){if("open"==e.data.id)worker.postMessage({action:"exec",id:"plot",sql:"SELECT * FROM pois"});else if("plot"==e.data.id){plotPOIs(e.data.results[0].values)}else if("export"==e.data.id){var o=e.data.buffer,t=new Blob([o]),i=document.createElement("a");document.body.appendChild(i),i.href=window.URL.createObjectURL(t),i.download="ViewrangerObjects.db",i.onclick=function(){setTimeout((function(){window.URL.revokeObjectURL(i.href)}),1500)},i.click()}}var worker=new Worker("./js/worker.sql-wasm.js");worker.onerror=error,worker.onmessage=workerMessage,loadBtn.addEventListener("change",loadDb,!0),exportBtn.addEventListener("click",exportDb,!0);for(var svgIcons=["activity","building","crossing","farm","fauna","flora","forest","helipad","hutshelter","jetty","lodging","medicalfacility","obstacle","outdoorswimming","peak","picnicarea","poi_green","poi_orange","poi_purple","poi_red","pub","publictoilets","restaurant","shop","steeprocks","touristinformation","turnleft","turnright","viewpoint","warningflag","water","waterfall","wildcamping"],i=1;i<=30;i++)svgIcons.push(i.toString());var pngIcons=["dot","geocache","parking"];function plotPOIs(e){for(var o=0;o<e.length;o++){if(svgIcons.includes(e[o][16]))var t=new L.Icon({iconUrl:"/resources/markers/svgs/"+e[o][16]+".svg",iconSize:[20,20],iconAnchor:[10,10]});else if(pngIcons.includes(e[o][16]))t=new L.Icon({iconUrl:"/resources/markers/pngs/"+e[o][16]+".png",iconSize:[20,20],iconAnchor:[10,10]});else if(e[o][16])t=new L.Icon.Default;else var t=new L.Icon({iconUrl:"/resources/markers/svgs/poi_yellowdefault.svg",iconSize:[20,20],iconAnchor:[10,10]});var i=L.marker([e[o][7],e[o][8]],{title:e[o][2],icon:t,uniqueID:e[o][3]});i.on("click",togglePOI),i.addTo(poiGroup),poiDict[i.options.uniqueID]=!0}map.fitBounds(poiGroup.getBounds())}function unplotPOIs(e){layers=poiGroup.getLayers();for(var o=0;o<layers.length;o++)e.includes(layers[o].options.uniqueID.toString())&&poiGroup.removeLayer(layers[o]._leaflet_id);map.fitBounds(poiGroup.getBounds())}function togglePOI(e){poiDict[e.target.options.uniqueID]?(e.target.setOpacity(.5),poiDict[e.target.options.uniqueID]=!1):(e.target.setOpacity(1),poiDict[e.target.options.uniqueID]=!0)}function boxToggle(e){for(var o in poiGroup._layers)e.contains(poiGroup._layers[o]._latlng)&&togglePOI({target:poiGroup._layers[o]})}L.Map.BoxToggle=L.Map.BoxZoom.extend({_onMouseUp:function(e){if((1===e.which||1===e.button)&&(this._finish(),this._moved)){this._clearDeferredResetState(),this._resetStateTimeout=setTimeout(L.bind(this._resetState,this),0);var o=new L.LatLngBounds(this._map.containerPointToLatLng(this._startPoint),this._map.containerPointToLatLng(this._point));boxToggle(o),this._map.fire("boxzoomend",{boxZoomBounds:o})}}}),L.Map.mergeOptions({boxZoom:!1}),L.Map.mergeOptions({boxToggle:!0}),L.Map.addInitHook("addHandler","boxToggle",L.Map.BoxToggle);var map=L.map("mapid").setView([51.505,-.09],2),poiGroup=(new L.featureGroup).addTo(map),poiDict={};L.tileLayer("https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",{attribution:'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',maxZoom:18,id:"mapbox/streets-v11",tileSize:512,zoomOffset:-1,accessToken:"pk.eyJ1IjoiYXJpY29vcGVyZGF2aXMiLCJhIjoiY2xydGJoeXNlMDRjeTJpcGI2emV4NDQ2eiJ9.rPD0kq2Z84bvPWbysoPzlg"}).addTo(map);